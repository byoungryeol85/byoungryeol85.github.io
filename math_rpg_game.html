<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—°ì‚°RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 800px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        .screen {
            width: 100%;
            height: 100%;
            display: none;
            padding: 40px;
            position: relative;
        }

        .screen.active {
            display: block !important;
        }

        .screen:not(.active) {
            display: none !important;
        }

        /* íƒ€ì´í‹€ í™”ë©´ */
        .title-screen {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .title-screen:not(.active) {
            display: none !important;
        }

        .title-screen h1 {
            font-size: 4em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .title-screen p {
            font-size: 1.2em;
            margin-bottom: 40px;
            opacity: 0.9;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        /* ìŠ¤í…Œì´ì§€ ì„ íƒ í™”ë©´ */
        .stage-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 30px;
        }

        .stage-card {
            background: linear-gradient(45deg, #FFE0B2, #FFCC02);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .stage-card:hover {
            transform: scale(1.05);
            border-color: #FF9800;
        }

        .stage-card.locked {
            background: #E0E0E0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .stage-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #E65100;
        }

        .stage-card p {
            font-size: 0.9em;
            color: #BF360C;
        }

        /* ì „íˆ¬ ì¤€ë¹„ í™”ë©´ */
        .battle-prep {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .battle-prep-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex: 1;
        }

        .monster-info, .player-info {
            width: 45%;
            text-align: center;
        }

        .monster {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .vs {
            font-size: 3em;
            font-weight: bold;
            color: #FF5722;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* ì „íˆ¬ í™”ë©´ ìƒˆë¡œìš´ ë ˆì´ì•„ì›ƒ */
        .battle-screen {
            padding: 15px;
            display: grid;
            grid-template-rows: auto auto 1fr auto auto;
            gap: 20px;
            height: calc(100% - 30px);
        }

        /* ìƒë‹¨ ì •ë³´ ì˜ì—­ */
        .battle-top {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: start;
        }

        .player-stats, .monster-stats {
            background: #F8F9FA;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #DEE2E6;
        }

        .player-stats h3, .monster-stats h3 {
            margin: 0 0 8px 0;
            font-size: 1.1em;
            color: #495057;
        }

        .stats-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #6C757D;
        }

        .health-bar {
            width: 100%;
            height: 25px;
            background: #E9ECEF;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 2px solid #ADB5BD;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #28A745, #20C997);
            transition: width 0.5s ease;
            position: relative;
        }

        .health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            font-size: 0.9em;
        }

        .game-info {
            text-align: center;
            background: #E3F2FD;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #BBDEFB;
        }

        .stage-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 5px;
        }

        .turn-info {
            font-size: 1em;
            color: #424242;
            margin-bottom: 8px;
        }

        .timer-display {
            font-size: 2em;
            font-weight: bold;
            color: #D32F2F;
            background: rgba(211, 47, 47, 0.1);
            padding: 8px 16px;
            border-radius: 8px;
            display: inline-block;
        }

        /* ìºë¦­í„° ì˜ì—­ */
        .character-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #E8F5E8, #F3E5F5);
            border-radius: 15px;
            border: 2px solid #C8E6C9;
        }

        .player-character, .monster-character {
            text-align: center;
            flex: 1;
        }

        .character-sprite {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4.5em;
            margin: 0 auto 15px;
            border: 4px solid #FFF;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .player-sprite {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
        }

        .monster-sprite {
            background: linear-gradient(45deg, #FF5722, #FF8A65);
        }

        .character-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .vs-text {
            font-size: 2.5em;
            font-weight: bold;
            color: #FF5722;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin: 0 20px;
        }

        /* ë¬¸ì œ ì˜ì—­ */
        .problem-area {
            background: #FFFFFF;
            border: 3px solid #007BFF;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .problem-text {
            font-size: 2.5em;
            font-weight: bold;
            color: #212529;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-all;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-area {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .answer-input {
            font-size: 2.2em;
            padding: 15px 25px;
            border: 3px solid #28A745;
            border-radius: 12px;
            text-align: center;
            width: 250px;
            outline: none;
            background: #FFFFFF;
            color: #212529;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .answer-input:focus {
            border-color: #FF6B35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
        }

        .submit-btn {
            font-size: 1.4em;
            padding: 18px 35px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            min-width: 120px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .submit-btn:hover {
            background: #0056B3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
            background: #004085;
        }

        /* í„´ ì „í™˜ ì˜¤ë²„ë ˆì´ */
        .turn-change-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .turn-change-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .turn-change-text {
            font-size: 3em;
            font-weight: bold;
            color: #FF5722;
            background: white;
            padding: 30px 50px;
            border-radius: 20px;
            border: 4px solid #FF5722;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* í”¼ë“œë°± ì˜¤ë²„ë ˆì´ */
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .feedback-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .feedback-overlay::before {
            content: attr(data-text);
            font-size: 3em;
            font-weight: bold;
            padding: 30px 50px;
            background: white;
            border-radius: 20px;
            border: 4px solid;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .feedback-overlay.correct::before {
            color: #28A745;
            border-color: #28A745;
        }

        .feedback-overlay.incorrect::before {
            color: #DC3545;
            border-color: #DC3545;
        }

        /* ìŠ¹ë¦¬ ì—°ì¶œ ì˜¤ë²„ë ˆì´ */
        .victory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.9), rgba(255, 165, 0, 0.9));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }

        .victory-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .victory-content {
            text-align: center;
            animation: victoryBounce 1s ease-in-out;
        }

        .victory-text {
            font-size: 4em;
            font-weight: bold;
            color: #FFF;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        .victory-subtext {
            font-size: 2em;
            color: #FFF;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        @keyframes victoryBounce {
            0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        /* ì „íˆ¬ ê²°ê³¼ í™”ë©´ */
        .result-screen {
            text-align: center;
        }

        .benefit-selection {
            margin: 30px 0;
        }

        .benefit-options {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .benefit-card {
            background: linear-gradient(45deg, #9C27B0, #E91E63);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            width: 200px;
        }

        .benefit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes damage {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); color: red; }
            100% { transform: scale(1); }
        }

        @keyframes critical {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(-5deg); }
            75% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .damage-animation {
            animation: damage 0.5s;
        }

        .critical-animation {
            animation: critical 0.8s;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- íƒ€ì´í‹€ í™”ë©´ -->
        <div class="screen active title-screen" id="title-screen">
            <h1>ğŸ¯ ì—°ì‚°RPG</h1>
            <p>ê³„ì‚°ìœ¼ë¡œ ëª¬ìŠ¤í„°ë¥¼ ë¬¼ë¦¬ì¹˜ì„¸ìš”!</p>
            <button class="btn btn-primary" onclick="showStageSelect()">ê²Œì„ ì‹œì‘</button>
        </div>

        <!-- ìŠ¤í…Œì´ì§€ ì„ íƒ í™”ë©´ -->
        <div class="screen" id="stage-select">
            <h2 style="text-align: center; margin-bottom: 20px; color: #333;">ìŠ¤í…Œì´ì§€ ì„ íƒ</h2>
            <div class="stage-grid" id="stage-grid">
                <!-- ìŠ¤í…Œì´ì§€ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-secondary" onclick="showTitle()">ë©”ì¸ìœ¼ë¡œ</button>
            </div>
        </div>

        <!-- ì „íˆ¬ ì¤€ë¹„ í™”ë©´ -->
        <div class="screen" id="battle-prep">
            <div class="battle-prep">
                <div class="battle-prep-content">
                    <div class="player-info">
                        <h2>í”Œë ˆì´ì–´ ì •ë³´</h2>
                        <div class="monster" style="background: linear-gradient(45deg, #2196F3, #21CBF3);">ğŸ§™â€â™‚ï¸</div>
                        <h3>ìš©ì‚¬</h3>
                        <p>ì²´ë ¥: <span id="player-hp-display">100</span>/<span id="player-maxhp-display">100</span></p>
                        <div class="prep-health-bar">
                            <div class="prep-health-fill" id="prep-player-health-bar"></div>
                        </div>
                        <p>ê³µê²©ë ¥: <span id="player-attack-display">20</span></p>
                        <p>í¬ë¦¬í‹°ì»¬: <span id="player-critical-display">30</span></p>
                    </div>
                    <div class="vs">VS</div>
                    <div class="monster-info">
                        <h2>ëª¬ìŠ¤í„° ì •ë³´</h2>
                        <div class="monster" id="monster-display">ğŸŸ¢</div>
                        <h3 id="monster-name">ë”í•˜ê¸° ìŠ¬ë¼ì„</h3>
                        <p>ì²´ë ¥: <span id="monster-hp-display">100</span></p>
                        <p>ê³µê²©ë ¥: <span id="monster-attack-display">35</span></p>
                        <div style="margin-top: 20px;">
                            <h4>ì£¼ìš” ë¬¸ì œ íŒ¨í„´</h4>
                            <p id="problem-pattern">í•œìë¦¬ìˆ˜ ë§ì…ˆ</p>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="startBattle()">ì „íˆ¬ ì‹œì‘!</button>
                    <button class="btn btn-secondary" onclick="showStageSelect()">ëŒì•„ê°€ê¸°</button>
                </div>
            </div>
        </div>

        <!-- ì „íˆ¬ í™”ë©´ -->
        <div class="screen" id="battle-screen">
            <!-- ìƒë‹¨ ì •ë³´ ì˜ì—­ -->
            <div class="battle-top">
                <!-- ì¢Œì¸¡ í”Œë ˆì´ì–´ ì •ë³´ -->
                <div class="player-stats">
                    <h3>ğŸ§™â€â™‚ï¸ ìš©ì‚¬</h3>
                    <div class="stats-row">
                        <span>âš”ï¸ <span id="player-attack-stat">20</span></span>
                        <span>ğŸ›¡ï¸ <span id="player-defense-stat">0</span></span>
                    </div>
                    <div class="health-bar">
                        <div class="health-fill" id="player-health-bar">
                            <div class="health-text" id="player-health-text">100/100</div>
                        </div>
                    </div>
                </div>

                <!-- ì¤‘ì•™ ê²Œì„ ì •ë³´ -->
                <div class="game-info">
                    <div class="stage-info">ìŠ¤í…Œì´ì§€ <span id="stage-number">1</span></div>
                    <div class="turn-info">í„´: <span id="turn-display">í”Œë ˆì´ì–´</span></div>
                    <div class="timer-display" id="timer">30</div>
                </div>

                <!-- ìš°ì¸¡ ëª¬ìŠ¤í„° ì •ë³´ -->
                <div class="monster-stats">
                    <h3 id="monster-name-battle">ğŸ‘¹ ìŠ¬ë¼ì„</h3>
                    <div class="stats-row">
                        <span>âš”ï¸ <span id="monster-attack-stat">35</span></span>
                        <span>ğŸ›¡ï¸ <span id="monster-defense-stat">0</span></span>
                    </div>
                    <div class="health-bar">
                        <div class="health-fill" id="monster-health-bar">
                            <div class="health-text" id="monster-health-text">100/100</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¤‘ì•™ ìºë¦­í„° ì˜ì—­ -->
            <div class="character-area">
                <div class="player-character">
                    <div class="character-sprite player-sprite">ğŸ§™â€â™‚ï¸</div>
                    <div class="character-name">ìš©ì‚¬</div>
                </div>
                <div class="vs-text">VS</div>
                <div class="monster-character">
                    <div class="character-sprite monster-sprite" id="monster-sprite">ğŸ‘¹</div>
                    <div class="character-name" id="monster-character-name">ìŠ¬ë¼ì„</div>
                </div>
            </div>

            <!-- ë¬¸ì œ ì˜ì—­ -->
            <div class="problem-area">
                <div class="problem-text" id="problem">ë¬¸ì œë¥¼ ìƒì„± ì¤‘...</div>
                <!-- ì½¤ë³´ í‘œì‹œ -->
                <div class="combo-display" id="combo-display" style="display: none;">2 COMBO!</div>
            </div>

            <!-- ë‹µ ì…ë ¥ ì˜ì—­ -->
            <div class="input-area">
                <input type="number" 
                       class="answer-input" 
                       id="answer-input" 
                       placeholder="ë‹µ ì…ë ¥"
                       autocomplete="off"
                       inputmode="numeric">
                <button class="submit-btn" 
                        id="submit-btn" 
                        type="button">í™•ì¸</button>
            </div>

            <!-- í„´ ì „í™˜ ì•Œë¦¼ -->
            <div class="turn-change-overlay" id="turn-change-overlay">
                <div class="turn-change-text" id="turn-change-text">ëª¬ìŠ¤í„° í„´!</div>
            </div>

            <!-- ìŠ¹ë¦¬ ì—°ì¶œ ì˜¤ë²„ë ˆì´ -->
            <div class="victory-overlay" id="victory-overlay">
                <div class="victory-content">
                    <div class="victory-text">ëª¬ìŠ¤í„° ì²˜ì¹˜!</div>
                    <div class="victory-subtext">Victory!</div>
                </div>
            </div>

            <!-- í”¼ë“œë°± ì˜¤ë²„ë ˆì´ -->
            <div class="feedback-overlay" id="feedback"></div>
            
            <!-- ë°ë¯¸ì§€ í”Œë˜ì‹œ -->
            <div class="damage-flash" id="damage-flash"></div>
        </div>

        <!-- ì „íˆ¬ ê²°ê³¼ í™”ë©´ -->
        <div class="screen" id="result-screen">
            <div class="result-content">
                <h2 id="result-title">ìŠ¹ë¦¬!</h2>
                <div style="margin: 30px 0;">
                    <p>ë§ì¶˜ ë¬¸ì œ ìˆ˜: <span id="final-correct">0</span>/5</p>
                    <p>íšë“ ì½”ì¸: <span id="earned-coins">50</span></p>
                </div>

                <div class="benefit-selection" id="benefit-selection">
                    <h3>ë³´ìƒ ì„ íƒ</h3>
                    <div class="benefit-options" id="benefit-options">
                        <!-- ë² ë„¤í• ì˜µì…˜ë“¤ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="nextStage()" id="next-stage-btn" style="display: none;">ë‹¤ìŒ ìŠ¤í…Œì´ì§€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ê²Œì„ ìƒíƒœ
        let currentStage = 1;
        let maxUnlockedStage = 1;
        let gameState = 'title';
        
        // í”Œë ˆì´ì–´ ëŠ¥ë ¥ì¹˜
        let player = {
            hp: 100,
            maxHp: 100,
            attack: 20,
            critical: 30,
            timeLimit: 30,
            defense: 0,
            shield: 0
        };

        // ìŠ¤í…Œì´ì§€ ì •ë³´
        const stageData = [
            { stage: 1, name: "ë”í•˜ê¸° ìŠ¬ë¼ì„", monster: "ğŸŸ¢", hp: 100, attack: 35, pattern: "í•œìë¦¬ìˆ˜ ë§ì…ˆ", color: "#4CAF50" },
            { stage: 2, name: "ë™êµ´ ë°•ì¥", monster: "ğŸ¦‡", hp: 120, attack: 40, pattern: "í•œìë¦¬ìˆ˜ ì‚¬ì¹™ì—°ì‚°", color: "#9C27B0" },
            { stage: 3, name: "ë…ë²„ì„¯", monster: "ğŸ„", hp: 140, attack: 45, pattern: "ë°›ì•„ì˜¬ë¦¼ì´ ìˆëŠ” ë§ì…ˆ", color: "#FF5722" },
            { stage: 4, name: "ëŠ‘ëŒ€", monster: "ğŸº", hp: 180, attack: 60, pattern: "ë‘ìë¦¬ìˆ˜ ë§ì…ˆ, ëº„ì…ˆ", color: "#607D8B" },
            { stage: 5, name: "ê³¨ë ˜", monster: "ğŸ—¿", hp: 220, attack: 70, pattern: "êµ¬êµ¬ë‹¨ê³¼ ê°„ë‹¨í•œ ë‚˜ëˆ—ì…ˆ", color: "#795548" },
            { stage: 6, name: "ë§ˆë²•ì‚¬", monster: "ğŸ§™", hp: 260, attack: 80, pattern: "ì„¸ìë¦¬ìˆ˜ ë§ì…ˆ, ëº„ì…ˆ", color: "#3F51B5" },
            { stage: 7, name: "ë“œë˜ê³¤", monster: "ğŸ²", hp: 320, attack: 95, pattern: "ë‘ìë¦¬ìˆ˜ ê³±ì…ˆ", color: "#F44336" },
            { stage: 8, name: "ì•…ë§ˆ", monster: "ğŸ‘º", hp: 380, attack: 110, pattern: "ë³µì¡í•œ ë‚˜ëˆ—ì…ˆ", color: "#E91E63" },
            { stage: 9, name: "ê±°ëŒ€ ê±°ë¯¸", monster: "ğŸ•·ï¸", hp: 450, attack: 125, pattern: "ì„¸ìë¦¬ìˆ˜ ì‚¬ì¹™ì—°ì‚°", color: "#424242" },
            { stage: 10, name: "ë§ˆì™•", monster: "ğŸ‘‘", hp: 550, attack: 150, pattern: "ìµœê³  ë‚œì´ë„ í˜¼í•© ë¬¸ì œ", color: "#000000" }
        ];

        // ë² ë„¤í• ì˜µì…˜ë“¤
        const benefits = [
            { name: "ê³µê²©ë ¥ ì¦ê°€", effect: () => player.attack += 5, desc: "ê³µê²©ë ¥ +5" },
            { name: "ì²´ë ¥ ì¦ê°€", effect: () => { player.maxHp += 20; player.hp += 20; }, desc: "ìµœëŒ€ ì²´ë ¥ +20" },
            { name: "ì œí•œì‹œê°„ ì¦ê°€", effect: () => player.timeLimit += 5, desc: "ì œí•œì‹œê°„ +5ì´ˆ" },
            { name: "í¬ë¦¬í‹°ì»¬ ì¦ê°€", effect: () => player.critical += 8, desc: "í¬ë¦¬í‹°ì»¬ ê³µê²©ë ¥ +8" },
            { name: "ë°©ì–´ë ¥ ì¦ê°€", effect: () => player.defense += 5, desc: "ë°©ì–´ë ¥ +5" },
            { name: "ì²´ë ¥ íšŒë³µ", effect: () => player.hp = Math.min(player.maxHp, player.hp + Math.floor(player.maxHp * 0.5)), desc: "ì²´ë ¥ 50% íšŒë³µ" },
            { name: "ë³´í˜¸ë§‰", effect: () => player.shield += 1, desc: "ë‹¤ìŒ ê³µê²© 1íšŒ ë¬´íš¨í™”" },
            { name: "ì½”ì¸ ë³´ë„ˆìŠ¤", effect: () => {}, desc: "ì¶”ê°€ ì½”ì¸ +30" }
        ];

        // ì „íˆ¬ ê´€ë ¨ ë³€ìˆ˜
        let currentMonster = {};
        let battleTimer = 30;
        let timerInterval;
        let correctAnswers = 0;
        let currentProblem = {};
        let playerTurn = true;
        let lastProblem = null; // ë§ˆì§€ë§‰ ë¬¸ì œ ì €ì¥
        let comboCount = 0; // ì—°ì† ì •ë‹µ ì½¤ë³´

        // í™”ë©´ ì „í™˜ í•¨ìˆ˜ë“¤
        function showScreen(screenId) {
            console.log('Switching to screen:', screenId);
            
            // ëª¨ë“  ìŠ¤í¬ë¦° ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
                screen.style.display = 'none';
            });
            
            // íƒ€ê²Ÿ ìŠ¤í¬ë¦° ë³´ì´ê¸°
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                targetScreen.style.display = 'block';
                console.log('Screen switched successfully to:', screenId);
            } else {
                console.error('Screen not found:', screenId);
            }
        }

        function showTitle() {
            gameState = 'title';
            showScreen('title-screen');
        }

        function showStageSelect() {
            console.log('showStageSelect called');
            gameState = 'stage-select';
            updateStageGrid();
            showScreen('stage-select');
        }

        function updateStageGrid() {
            console.log('updateStageGrid called');
            const grid = document.getElementById('stage-grid');
            if (!grid) {
                console.error('Stage grid element not found');
                return;
            }
            grid.innerHTML = '';
            
            stageData.forEach((stage, index) => {
                const card = document.createElement('div');
                card.className = `stage-card ${index + 1 > maxUnlockedStage ? 'locked' : ''}`;
                card.innerHTML = `
                    <h3>ìŠ¤í…Œì´ì§€ ${stage.stage}</h3>
                    <div style="font-size: 2em; margin: 10px 0;">${stage.monster}</div>
                    <p><strong>${stage.name}</strong></p>
                    <p>${stage.pattern}</p>
                `;
                
                if (index + 1 <= maxUnlockedStage) {
                    card.onclick = () => selectStage(index + 1);
                }
                
                grid.appendChild(card);
            });
            console.log('Stage grid updated with', stageData.length, 'stages');
        }

        function selectStage(stageNum) {
            currentStage = stageNum;
            const stage = stageData[stageNum - 1];
            currentMonster = { ...stage };
            
            // ì „íˆ¬ ì¤€ë¹„ í™”ë©´ ì—…ë°ì´íŠ¸
            document.getElementById('monster-display').textContent = stage.monster;
            document.getElementById('monster-display').style.background = `linear-gradient(45deg, ${stage.color}, ${stage.color}99)`;
            document.getElementById('monster-name').textContent = stage.name;
            document.getElementById('monster-hp-display').textContent = stage.hp;
            document.getElementById('monster-attack-display').textContent = stage.attack;
            document.getElementById('problem-pattern').textContent = stage.pattern;
            
            document.getElementById('player-hp-display').textContent = player.hp;
            document.getElementById('player-maxhp-display').textContent = player.maxHp;
            document.getElementById('player-attack-display').textContent = player.attack;
            document.getElementById('player-critical-display').textContent = player.critical;
            
            // ì¤€ë¹„í™”ë©´ ì²´ë ¥ë°” ì—…ë°ì´íŠ¸
            const prepHealthBar = document.getElementById('prep-player-health-bar');
            if (prepHealthBar) {
                const healthPercent = (player.hp / player.maxHp) * 100;
                prepHealthBar.style.width = healthPercent + '%';
            }
            
            showScreen('battle-prep');
        }

        function startBattle() {
            console.log('Starting battle...');
            gameState = 'battle';
            // ì „íˆ¬ ìƒíƒœ ì´ˆê¸°í™”
            correctAnswers = 0;
            comboCount = 0;
            playerTurn = true;
            battleTimer = player.timeLimit;
            lastProblem = null;
            
            // UI ì—…ë°ì´íŠ¸
            updateBattleUI();
            
            console.log('Switching to battle screen...');
            showScreen('battle-screen');
            
            // í™”ë©´ ì „í™˜ í›„ ë°”ë¡œ í”Œë ˆì´ì–´ í„´ ì‹œì‘ (ì—°ì¶œ í¬í•¨)
            setTimeout(() => {
                showPlayerTurnOverlay();
                setTimeout(() => {
                    hidePlayerTurnOverlay();
                    console.log('Generating first problem...');
                    generateProblem();
                    startTimer();
                }, 1500);
            }, 100);
        }

        function updateBattleUI() {
            // ìŠ¤í…Œì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
            const stageNumber = document.getElementById('stage-number');
            if (stageNumber) stageNumber.textContent = currentStage;
            
            // í”Œë ˆì´ì–´ ì •ë³´ ì—…ë°ì´íŠ¸
            const playerAttackStat = document.getElementById('player-attack-stat');
            const playerDefenseStat = document.getElementById('player-defense-stat');
            if (playerAttackStat) playerAttackStat.textContent = player.attack;
            if (playerDefenseStat) playerDefenseStat.textContent = player.defense;
            
            // ëª¬ìŠ¤í„° ì •ë³´ ì—…ë°ì´íŠ¸
            const monsterNameBattle = document.getElementById('monster-name-battle');
            const monsterAttackStat = document.getElementById('monster-attack-stat');
            const monsterDefenseStat = document.getElementById('monster-defense-stat');
            const monsterSprite = document.getElementById('monster-sprite');
            const monsterCharacterName = document.getElementById('monster-character-name');
            
            if (monsterNameBattle) monsterNameBattle.textContent = `${currentMonster.monster} ${currentMonster.name}`;
            if (monsterAttackStat) monsterAttackStat.textContent = currentMonster.attack;
            if (monsterDefenseStat) monsterDefenseStat.textContent = currentMonster.defense || 0;
            if (monsterSprite) {
                monsterSprite.textContent = currentMonster.monster;
                monsterSprite.style.background = `linear-gradient(45deg, ${currentMonster.color}, ${currentMonster.color}99)`;
            }
            if (monsterCharacterName) monsterCharacterName.textContent = currentMonster.name;
            
            // í„´ ì •ë³´ ì—…ë°ì´íŠ¸
            const turnDisplay = document.getElementById('turn-display');
            if (turnDisplay) turnDisplay.textContent = 'í”Œë ˆì´ì–´';
            
            updateHealthBars();
        }

        function generateProblem() {
            const stage = currentStage;
            let problem;
            
            console.log('Generating problem for stage:', stage);
            
            try {
                if (stage <= 2) {
                    problem = generateSimpleAddSub();
                } else if (stage <= 3) {
                    problem = generateCarryAddition();
                } else if (stage <= 4) {
                    problem = generateTwoDigitAddSub();
                } else if (stage <= 5) {
                    problem = generateMultiplyDivide();
                } else if (stage <= 6) {
                    problem = generateThreeDigitAddSub();
                } else if (stage <= 7) {
                    problem = generateTwoDigitMultiply();
                } else if (stage <= 8) {
                    problem = generateComplexDivide();
                } else {
                    problem = generateMixedProblems();
                }
                
                console.log('Generated problem:', problem);
                
                if (!problem || !problem.question || problem.answer === undefined) {
                    throw new Error('Invalid problem generated');
                }
                
                // ê°™ì€ ë¬¸ì œê°€ ì—°ë‹¬ì•„ ë‚˜ì˜¤ì§€ ì•Šë„ë¡ ì²´í¬
                if (lastProblem && problem.question === lastProblem.question && problem.answer === lastProblem.answer) {
                    console.log('Same problem detected, regenerating...');
                    // ë‹¤ì‹œ ìƒì„± (ìµœëŒ€ 3ë²ˆ ì‹œë„)
                    for (let i = 0; i < 3; i++) {
                        if (stage <= 2) {
                            problem = generateSimpleAddSub();
                        } else if (stage <= 3) {
                            problem = generateCarryAddition();
                        } else if (stage <= 4) {
                            problem = generateTwoDigitAddSub();
                        } else if (stage <= 5) {
                            problem = generateMultiplyDivide();
                        } else if (stage <= 6) {
                            problem = generateThreeDigitAddSub();
                        } else if (stage <= 7) {
                            problem = generateTwoDigitMultiply();
                        } else if (stage <= 8) {
                            problem = generateComplexDivide();
                        } else {
                            problem = generateMixedProblems();
                        }
                        
                        if (!lastProblem || problem.question !== lastProblem.question || problem.answer !== lastProblem.answer) {
                            break;
                        }
                    }
                }
                
                lastProblem = { ...problem };
                currentProblem = problem;
                const problemElement = document.getElementById('problem');
                if (problemElement) {
                    problemElement.textContent = `${problem.question} = ?`;
                    console.log('Problem displayed:', problem.question);
                } else {
                    console.error('Problem element not found');
                }
                
                const inputElement = document.getElementById('answer-input');
                if (inputElement) {
                    inputElement.value = '';
                    setTimeout(() => {
                        inputElement.focus();
                        inputElement.click();
                    }, 200);
                } else {
                    console.error('Answer input element not found');
                }
                
            } catch (error) {
                console.error('Error generating problem:', error);
                // ê¸°ë³¸ ë¬¸ì œë¡œ ëŒ€ì²´
                problem = { question: '5 + 3', answer: 8 };
                currentProblem = problem;
                const problemElement = document.getElementById('problem');
                if (problemElement) {
                    problemElement.textContent = `${problem.question} = ?`;
                } else {
                    console.error('Problem element not found in catch block');
                }
                
                const inputElement = document.getElementById('answer-input');
                if (inputElement) {
                    inputElement.value = '';
                    setTimeout(() => {
                        inputElement.focus();
                        inputElement.click();
                    }, 200);
                }
            }
        }

        // ë¬¸ì œ ìƒì„± í•¨ìˆ˜ë“¤
        function generateSimpleAddSub() {
            try {
                if (currentStage === 1) {
                    // 1ìŠ¤í…Œì´ì§€ëŠ” ë§ì…ˆë§Œ
                    const a = Math.floor(Math.random() * 9) + 1;
                    const b = Math.floor(Math.random() * 9) + 1;
                    return { question: `${a} + ${b}`, answer: a + b };
                } else {
                    // 2ìŠ¤í…Œì´ì§€ë¶€í„°ëŠ” ë§ì…ˆ, ëº„ì…ˆ ëª¨ë‘
                    const a = Math.floor(Math.random() * 9) + 1;
                    const b = Math.floor(Math.random() * 9) + 1;
                    const operations = ['+', '-'];
                    const operation = operations[Math.floor(Math.random() * 2)];
                    
                    if (operation === '+') {
                        return { question: `${a} + ${b}`, answer: a + b };
                    } else {
                        const larger = Math.max(a, b);
                        const smaller = Math.min(a, b);
                        return { question: `${larger} - ${smaller}`, answer: larger - smaller };
                    }
                }
            } catch (error) {
                console.error('Error in generateSimpleAddSub:', error);
                return { question: '5 + 3', answer: 8 };
            }
        }

        function generateCarryAddition() {
            const a = Math.floor(Math.random() * 9) + 1;
            const b = Math.floor(Math.random() * (10 - a)) + (10 - a);
            return { question: `${a} + ${b}`, answer: a + b };
        }

        function generateTwoDigitAddSub() {
            const a = Math.floor(Math.random() * 90) + 10;
            const b = Math.floor(Math.random() * 90) + 10;
            const operation = Math.random() < 0.5 ? '+' : '-';
            
            if (operation === '+') {
                return { question: `${a} + ${b}`, answer: a + b };
            } else {
                const larger = Math.max(a, b);
                const smaller = Math.min(a, b);
                return { question: `${larger} - ${smaller}`, answer: larger - smaller };
            }
        }

        function generateMultiplyDivide() {
            if (Math.random() < 0.6) {
                const a = Math.floor(Math.random() * 9) + 2;
                const b = Math.floor(Math.random() * 9) + 2;
                return { question: `${a} Ã— ${b}`, answer: a * b };
            } else {
                const b = Math.floor(Math.random() * 9) + 2;
                const answer = Math.floor(Math.random() * 9) + 2;
                const a = b * answer;
                return { question: `${a} Ã· ${b}`, answer: answer };
            }
        }

        function generateThreeDigitAddSub() {
            const a = Math.floor(Math.random() * 900) + 100;
            const b = Math.floor(Math.random() * 900) + 100;
            const operation = Math.random() < 0.5 ? '+' : '-';
            
            if (operation === '+') {
                return { question: `${a} + ${b}`, answer: a + b };
            } else {
                const larger = Math.max(a, b);
                const smaller = Math.min(a, b);
                return { question: `${larger} - ${smaller}`, answer: larger - smaller };
            }
        }

        function generateTwoDigitMultiply() {
            const a = Math.floor(Math.random() * 90) + 10;
            const b = Math.floor(Math.random() * 9) + 2;
            return { question: `${a} Ã— ${b}`, answer: a * b };
        }

        function generateComplexDivide() {
            const b = Math.floor(Math.random() * 20) + 5;
            const answer = Math.floor(Math.random() * 20) + 5;
            const a = b * answer;
            return { question: `${a} Ã· ${b}`, answer: answer };
        }

        function generateMixedProblems() {
            const operations = [generateThreeDigitAddSub, generateTwoDigitMultiply, generateComplexDivide];
            const selectedOp = operations[Math.floor(Math.random() * operations.length)];
            return selectedOp();
        }

        function startTimer() {
            document.getElementById('timer').textContent = battleTimer;
            
            timerInterval = setInterval(() => {
                battleTimer--;
                document.getElementById('timer').textContent = battleTimer;
                
                if (battleTimer <= 0) {
                    clearInterval(timerInterval);
                    endPlayerTurn();
                }
            }, 1000);
        }

        function submitAnswer() {
            console.log('Submit answer clicked');
            const userAnswer = parseInt(document.getElementById('answer-input').value);
            
            if (isNaN(userAnswer)) {
                console.log('Invalid input, focusing on input field');
                document.getElementById('answer-input').focus();
                return;
            }
            
            console.log('User answer:', userAnswer, 'Correct answer:', currentProblem.answer);
            
            if (userAnswer === currentProblem.answer) {
                correctAnswers++;
                comboCount++;
                
                // ì½¤ë³´ í‘œì‹œ ì—…ë°ì´íŠ¸
                updateComboDisplay();
                
                // ì •ë‹µê³¼ ë°ë¯¸ì§€ë¥¼ í•¨ê»˜ í‘œì‹œ
                if (correctAnswers === 5) {
                    performCriticalAttack();
                    showFeedback(`ì •ë‹µ! í¬ë¦¬í‹°ì»¬ ${player.critical} ë°ë¯¸ì§€!`, 'critical');
                } else {
                    performNormalAttack();
                    showFeedback(`ì •ë‹µ! ${player.attack} ë°ë¯¸ì§€!`, 'correct');
                }
                
                if (currentMonster.hp <= 0) {
                    clearInterval(timerInterval);
                    showVictorySequence();
                    return;
                } else if (correctAnswers < 5) {
                    setTimeout(() => {
                        generateProblem();
                    }, 1500);
                } else {
                    clearInterval(timerInterval);
                    setTimeout(() => {
                        endPlayerTurn();
                    }, 1500);
                }
            } else {
                // ì˜¤ë‹µ - ì½¤ë³´ ë¦¬ì…‹ (ì´ë¯¸ endPlayerTurnì—ì„œ ì²˜ë¦¬ë¨)
                showFeedback('í‹€ë ¸ìŠµë‹ˆë‹¤!', 'incorrect');
                clearInterval(timerInterval);
                battleTimer = 0;
                document.getElementById('timer').textContent = '0';
                setTimeout(() => {
                    endPlayerTurn();
                }, 1500);
            }
        }

        function performNormalAttack() {
            const damage = player.attack;
            currentMonster.hp = Math.max(0, currentMonster.hp - damage);
            updateHealthBars();
        }

        function performCriticalAttack() {
            const damage = player.critical;
            currentMonster.hp = Math.max(0, currentMonster.hp - damage);
            updateHealthBars();
        }

        function updateComboDisplay() {
            const comboDisplay = document.getElementById('combo-display');
            if (comboDisplay) {
                if (comboCount >= 2) {
                    comboDisplay.textContent = `${comboCount} COMBO!`;
                    comboDisplay.style.display = 'block';
                    comboDisplay.classList.add('show');
                } else {
                    comboDisplay.style.display = 'none';
                    comboDisplay.classList.remove('show');
                }
            }
        }

        function showDamage(damage, isCritical) {
            const monsterElement = document.getElementById('monster-name-battle');
            if (isCritical) {
                monsterElement.classList.add('critical-animation');
                showFeedback(`í¬ë¦¬í‹°ì»¬! ${damage} ë°ë¯¸ì§€!`, 'critical');
                setTimeout(() => monsterElement.classList.remove('critical-animation'), 800);
            } else {
                monsterElement.classList.add('damage-animation');
                showFeedback(`${damage} ë°ë¯¸ì§€!`, 'correct');
                setTimeout(() => monsterElement.classList.remove('damage-animation'), 500);
            }
        }

        function showFeedback(text, type) {
            const feedback = document.getElementById('feedback');
            feedback.setAttribute('data-text', text);
            feedback.className = `feedback-overlay ${type} show`;
            
            // ì²´ë ¥ë°”ë¥¼ í”¼ë“œë°± ìœ„ì— ë³´ì´ë„ë¡ z-index ì¡°ì •
            const healthBars = document.querySelectorAll('.health-bar, .health-fill, .health-text');
            healthBars.forEach(bar => {
                bar.style.zIndex = '2500';
                bar.style.position = 'relative';
            });
            
            setTimeout(() => {
                feedback.classList.remove('show');
                // z-index ì›ë³µ
                healthBars.forEach(bar => {
                    bar.style.zIndex = '';
                    bar.style.position = '';
                });
            }, 1500);
        }

        function updateHealthBars() {
            // ëª¬ìŠ¤í„° ì²´ë ¥ë°”
            const monsterStage = stageData[currentStage - 1];
            const monsterHpPercent = (currentMonster.hp / monsterStage.hp) * 100;
            document.getElementById('monster-health-bar').style.width = monsterHpPercent + '%';
            document.getElementById('monster-health-text').textContent = `${currentMonster.hp}/${monsterStage.hp}`;
            
            // í”Œë ˆì´ì–´ ì²´ë ¥ë°”
            const playerHpPercent = (player.hp / player.maxHp) * 100;
            document.getElementById('player-health-bar').style.width = playerHpPercent + '%';
            document.getElementById('player-health-text').textContent = `${player.hp}/${player.maxHp}`;
        }

        function endPlayerTurn() {
            playerTurn = false;
            // ì‹œê°„ ì´ˆê³¼ ë˜ëŠ” ì˜¤ë‹µìœ¼ë¡œ í„´ì´ ëë‚˜ë©´ ì½¤ë³´ ë¦¬ì…‹
            comboCount = 0;
            updateComboDisplay();
            
            const turnDisplay = document.getElementById('turn-display');
            if (turnDisplay) turnDisplay.textContent = 'ëª¬ìŠ¤í„°';
            
            showTurnChangeOverlay();
            
            setTimeout(() => {
                hideTurnChangeOverlay();
                performMonsterAttack();
            }, 2000);
        }

        function showTurnChangeOverlay() {
            const overlay = document.getElementById('turn-change-overlay');
            const text = document.getElementById('turn-change-text');
            if (overlay && text) {
                text.textContent = 'ëª¬ìŠ¤í„° í„´!';
                text.style.color = '#FF5722';
                text.style.borderColor = '#FF5722';
                overlay.classList.add('show');
            }
        }

        function hideTurnChangeOverlay() {
            const overlay = document.getElementById('turn-change-overlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        function showVictorySequence() {
            // ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì‹œ ì½¤ë³´ ë¦¬ì…‹
            comboCount = 0;
            updateComboDisplay();
            
            // ëª¬ìŠ¤í„° ì²˜ì¹˜ ì—°ì¶œ
            const monsterSprite = document.getElementById('monster-sprite');
            if (monsterSprite) {
                monsterSprite.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    monsterSprite.style.opacity = '0.3';
                    monsterSprite.style.transform = 'scale(0.8)';
                }, 500);
            }
            
            // ìŠ¹ë¦¬ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            setTimeout(() => {
                const victoryOverlay = document.getElementById('victory-overlay');
                if (victoryOverlay) {
                    victoryOverlay.classList.add('show');
                }
            }, 1000);
            
            // ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™
            setTimeout(() => {
                const victoryOverlay = document.getElementById('victory-overlay');
                if (victoryOverlay) {
                    victoryOverlay.classList.remove('show');
                }
                showVictory();
            }, 3000);
        }

        function performMonsterAttack() {
            if (player.shield > 0) {
                player.shield--;
                showFeedback('ê³µê²© ì°¨ë‹¨!', 'correct');
            } else {
                const damage = Math.max(1, currentMonster.attack - player.defense);
                player.hp = Math.max(0, player.hp - damage);
                
                // RPG ìŠ¤íƒ€ì¼ ë°ë¯¸ì§€ ì—°ì¶œ
                showDamageEffect();
                showFeedback(`${damage} ë°ë¯¸ì§€ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤!`, 'incorrect');
            }
            
            updateHealthBars();
            
            if (player.hp <= 0) {
                setTimeout(() => showGameOver(), 1000);
            } else {
                setTimeout(() => startPlayerTurn(), 1500);
            }
        }

        function showDamageEffect() {
            // í™”ë©´ í”ë“¤ê¸°
            const container = document.querySelector('.container');
            if (container) {
                container.classList.add('screen-shake');
                setTimeout(() => {
                    container.classList.remove('screen-shake');
                }, 500);
            }
            
            // ë¹¨ê°„ í”Œë˜ì‹œ
            const damageFlash = document.getElementById('damage-flash');
            if (damageFlash) {
                damageFlash.classList.add('show');
                setTimeout(() => {
                    damageFlash.classList.remove('show');
                }, 600);
            }
        }

        function startPlayerTurn() {
            playerTurn = true;
            correctAnswers = 0;
            battleTimer = player.timeLimit;
            
            const turnDisplay = document.getElementById('turn-display');
            if (turnDisplay) turnDisplay.textContent = 'í”Œë ˆì´ì–´';
            
            // í”Œë ˆì´ì–´ í„´ ì‹œì‘ ì•Œë¦¼ í‘œì‹œ (ì²« í„´ ì œì™¸)
            if (comboCount > 0 || currentMonster.hp < stageData[currentStage - 1].hp) {
                showPlayerTurnOverlay();
                setTimeout(() => {
                    hidePlayerTurnOverlay();
                    generateProblem();
                    startTimer();
                }, 1500);
            } else {
                // ì²« í„´ì´ë©´ ë°”ë¡œ ì‹œì‘
                generateProblem();
                startTimer();
            }
        }

        function showPlayerTurnOverlay() {
            const overlay = document.getElementById('turn-change-overlay');
            const text = document.getElementById('turn-change-text');
            if (overlay && text) {
                text.textContent = 'í”Œë ˆì´ì–´ í„´!';
                text.style.color = '#2196F3';
                text.style.borderColor = '#2196F3';
                overlay.classList.add('show');
            }
        }

        function hidePlayerTurnOverlay() {
            const overlay = document.getElementById('turn-change-overlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        function showVictory() {
            gameState = 'result';
            const coinsEarned = 50 + (currentStage * 10);
            
            const resultTitle = document.getElementById('result-title');
            const finalCorrect = document.getElementById('final-correct');
            const earnedCoins = document.getElementById('earned-coins');
            const benefitSelection = document.getElementById('benefit-selection');
            const nextStageBtn = document.getElementById('next-stage-btn');
            
            if (resultTitle) resultTitle.textContent = 'ìŠ¹ë¦¬!';
            if (finalCorrect) finalCorrect.textContent = correctAnswers;
            if (earnedCoins) earnedCoins.textContent = coinsEarned;
            
            // ë² ë„¤í• ì„ íƒ í•­ìƒ í‘œì‹œ
            if (benefitSelection) benefitSelection.style.display = 'block';
            
            // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ë²„íŠ¼ì€ ë² ë„¤í• ì„ íƒ í›„ì—ë§Œ í‘œì‹œ
            if (nextStageBtn) {
                nextStageBtn.style.display = 'none';
                if (currentStage >= 10) {
                    nextStageBtn.textContent = 'ê²Œì„ í´ë¦¬ì–´!';
                } else {
                    nextStageBtn.textContent = 'ë‹¤ìŒ ìŠ¤í…Œì´ì§€';
                }
            }
            
            if (currentStage === maxUnlockedStage && currentStage < 10) {
                maxUnlockedStage++;
            }
            
            generateBenefitOptions();
            showScreen('result-screen');
        }

        function showGameOver() {
            gameState = 'result';
            maxUnlockedStage = 1;
            player = {
                hp: 100,
                maxHp: 100,
                attack: 20,
                critical: 30,
                timeLimit: 30,
                defense: 0,
                shield: 0
            };
            
            const resultTitle = document.getElementById('result-title');
            const finalCorrect = document.getElementById('final-correct');
            const earnedCoins = document.getElementById('earned-coins');
            const benefitSelection = document.getElementById('benefit-selection');
            const nextStageBtn = document.getElementById('next-stage-btn');
            
            if (resultTitle) resultTitle.textContent = 'íŒ¨ë°°...';
            if (finalCorrect) finalCorrect.textContent = correctAnswers;
            if (earnedCoins) earnedCoins.textContent = '0';
            if (benefitSelection) benefitSelection.style.display = 'none';
            if (nextStageBtn) nextStageBtn.style.display = 'none';
            
            showScreen('result-screen');
        }

        function generateBenefitOptions() {
            const benefitContainer = document.getElementById('benefit-options');
            if (!benefitContainer) return;
            
            benefitContainer.innerHTML = '';
            
            const shuffled = [...benefits].sort(() => 0.5 - Math.random());
            const selectedBenefits = shuffled.slice(0, 3);
            
            selectedBenefits.forEach((benefit, index) => {
                const card = document.createElement('div');
                card.className = 'benefit-card';
                card.innerHTML = `
                    <h4>${benefit.name}</h4>
                    <p>${benefit.desc}</p>
                `;
                card.onclick = () => selectBenefit(benefit);
                benefitContainer.appendChild(card);
            });
        }

        function selectBenefit(benefit) {
            benefit.effect();
            
            const benefitSelection = document.getElementById('benefit-selection');
            if (benefitSelection) {
                benefitSelection.innerHTML = `
                    <h3 style="color: #28A745; margin-bottom: 15px;">âœ“ ì„ íƒ ì™„ë£Œ: ${benefit.name}</h3>
                    <p style="font-size: 1.1em; color: #495057;">${benefit.desc}</p>
                `;
            }
            
            // ë² ë„¤í• ì„ íƒ í›„ ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ë²„íŠ¼ í‘œì‹œ
            const nextStageBtn = document.getElementById('next-stage-btn');
            if (nextStageBtn) {
                nextStageBtn.style.display = 'inline-block';
            }
        }

        function nextStage() {
            // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ì‹œì‘ ì‹œ ì½¤ë³´ ë¦¬ì…‹
            comboCount = 0;
            
            if (currentStage < 10) {
                // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ìë™ ì´ë™
                currentStage++;
                const stage = stageData[currentStage - 1];
                currentMonster = { ...stage };
                
                // ì „íˆ¬ ì¤€ë¹„ í™”ë©´ ì—…ë°ì´íŠ¸
                document.getElementById('monster-display').textContent = stage.monster;
                document.getElementById('monster-display').style.background = `linear-gradient(45deg, ${stage.color}, ${stage.color}99)`;
                document.getElementById('monster-name').textContent = stage.name;
                document.getElementById('monster-hp-display').textContent = stage.hp;
                document.getElementById('monster-attack-display').textContent = stage.attack;
                document.getElementById('problem-pattern').textContent = stage.pattern;
                
                document.getElementById('player-hp-display').textContent = player.hp;
                document.getElementById('player-maxhp-display').textContent = player.maxHp;
                document.getElementById('player-attack-display').textContent = player.attack;
                document.getElementById('player-critical-display').textContent = player.critical;
                
                // ì¤€ë¹„í™”ë©´ ì²´ë ¥ë°” ì—…ë°ì´íŠ¸
                const prepHealthBar = document.getElementById('prep-player-health-bar');
                if (prepHealthBar) {
                    const healthPercent = (player.hp / player.maxHp) * 100;
                    prepHealthBar.style.width = healthPercent + '%';
                }
                
                showScreen('battle-prep');
            } else {
                // ê²Œì„ í´ë¦¬ì–´
                alert('ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤! ğŸ‰');
                showStageSelect();
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
        document.addEventListener('DOMContentLoaded', function() {
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn) {
                submitBtn.addEventListener('click', submitAnswer);
                submitBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    submitAnswer();
                });
            }

            const answerInput = document.getElementById('answer-input');
            if (answerInput) {
                answerInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        submitAnswer();
                    }
                });
                
                answerInput.addEventListener('focus', function() {
                    console.log('Input focused');
                });
                
                answerInput.addEventListener('click', function() {
                    this.focus();
                });
            }
        });

        document.addEventListener('keydown', (e) => {
            if (gameState === 'battle' && e.key === 'Enter') {
                e.preventDefault();
                submitAnswer();
            }
        });

        window.onload = () => {
            updateStageGrid();
        };
    </script>
</body>
</html>